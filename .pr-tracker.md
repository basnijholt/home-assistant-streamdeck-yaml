# PR Tracker - home-assistant-streamdeck-yaml

> **Last Updated**: 2025-12-23
> **Local file - not tracked in git**

## Summary

| Status | Count |
|--------|-------|
| Open PRs | 10 |
| Reviewed | 11 |
| Ready to merge | 0 |
| Needs rebase | 4 |

---

## Recently Reviewed & Merged

| PR | Title | Verdict | Date |
|----|-------|---------|------|
| #251 | Add long press functionality | âœ… Merged | 2025-12-23 |
| #258 | Handle network disconnection gracefully | âœ… Merged | 2025-12-23 |
| #279 | Allow multiple includes | âœ… Merged | 2025-12-23 |
| #278 | Fix nested includes | âœ… Merged | 2025-12-23 |
| #297 | Refactor: inline get_lcd_size | âœ… Merged | 2025-12-23 |
| #276 | Dial Clearing | âœ… Merged | 2025-12-23 |
| #274 | Fix yaml loading bug | âœ… Merged | 2025-12-23 |
| #259 | Refactor special_type_data validation | âœ… Merged | 2025-12-23 |

---

## Open PRs - Detailed Tracker

### Priority: Small & Ready

| PR | Title | +/- | Has Tests | Author | Review Status |
|----|-------|-----|-----------|--------|---------------|
| ~~#257~~ | ~~Add methods to manage detached pages~~ | ~~+17/-2~~ | ~~âœ…~~ | ~~@ngolf~~ | âŒ CLOSED (obsolete - already in main via PR #246) |
| ~~#279~~ | ~~Allow multiple includes~~ | ~~+79/-23~~ | ~~âœ…~~ | ~~@ngolf~~ | âœ… MERGED |
| ~~#206~~ | ~~Flatten list~~ | ~~+27/-0~~ | ~~âŒ~~ | ~~@tim-haselhoff~~ | âŒ CLOSED (superseded by #279) |
| #172 | Signal handling SIGINT/SIGTERM | +22/-1 | âŒ | @cor73x | ğŸ”„ Needs rebase |
| #142 | Allow empty text with "" | +23/-17 | âŒ | @basnijholt | ğŸ”„ Needs rebase (conflicts) |

### Priority: Medium

| PR | Title | +/- | Has Tests | Author | Review Status |
|----|-------|-----|-----------|--------|---------------|
| ~~#258~~ | ~~Handle network disconnection gracefully~~ | ~~+144/-6~~ | ~~âœ…~~ | ~~@ngolf~~ | âœ… MERGED |
| #173 | Sync state entity back to HA | +52/-1 | âŒ | @cor73x | ğŸ”² Not reviewed |
| #193 | Add inactivity timer | +31/-0 | âŒ | @StopMotionCuber | ğŸ”² Not reviewed |

### Priority: Large / Complex

| PR | Title | +/- | Has Tests | Author | Review Status |
|----|-------|-----|-----------|--------|---------------|
| ~~#251~~ | ~~Add long press functionality~~ | ~~+333/-77~~ | ~~âœ…~~ | ~~@ngolf~~ | âœ… MERGED |
| #250 | Light page tweaks new | +472/-88 | âœ… | @ngolf | ğŸ”„ Needs rebase (conflicts with #251 merge) |
| #256 | Climate page | +703/-83 | âœ… | @ngolf | ğŸ”² Not reviewed |
| #260 | Return to screen after inactivity | +802/-94 | âœ… | @ngolf | ğŸ”² Not reviewed |
| #264 | Connection page with status buttons | +644/-55 | âœ… | @ngolf | ğŸ”² Not reviewed |
| #277 | Fix lcd multi dial update bug | +1226/-436 | âœ… | @ngolf | ğŸ”² Not reviewed |

### Priority: WIP / Stale

| PR | Title | +/- | Has Tests | Author | Review Status | Notes |
|----|-------|-----|-----------|--------|---------------|-------|
| #37 | WIP: climate page | +27/-1 | âŒ | @basnijholt | ğŸ”² Stale | Created 2023-04 |
| #38 | WIP: special type basemodel | +49/-6 | âŒ | @basnijholt | ğŸ”² Stale | Created 2023-04 |

---

## Detailed PR Notes

### #257 - Add methods to manage detached pages âŒ CLOSED
- **Files**: `home_assistant_streamdeck_yaml.py`, `tests/test_app.py`
- **Purpose**: Adds helper methods for detached page management
- **Status**: CLOSED as obsolete
- **Reason**: PR #257 was created 2025-04-18, but PR #246 was merged 2025-04-19 and included the same methods. Both from @ngolf - split work, but #246 merged first.

### #172 - Signal handling SIGINT/SIGTERM ğŸ”„ Needs rebase
- **Files**: `home_assistant_streamdeck_yaml.py`
- **Purpose**: Handle Ctrl+C and systemctl stop gracefully, reset/close StreamDeck
- **Created**: Jan 2024
- **Problems**:
  - Based on old code before retry logic (PR #258) was added
  - Multiple merge conflicts in imports, `run()` function, and `main()`
  - PR's approach: move `deck = get_deck()` to `main()` and pass to `run()`
  - Current `run()` creates deck internally with retry logic
- **Concept is good**: Signal handling for clean shutdown is valuable
- **Required**: Author needs to rebase on current main or implement fresh
- **Status**: Cannot merge as-is, conflicts too extensive for simple resolution

### #206 - Flatten list âŒ OBSOLETE
- **Files**: `home_assistant_streamdeck_yaml.py`
- **Purpose**: Flatten nested lists in buttons/dials after YAML loading
- **Created**: Nov 2024
- **Approach**: Post-processing via `flat_interactable()` in `Config.load()`
- **Status**: OBSOLETE - superseded by PR #279
- **Reason**: PR #279 (merged 2025-12-23) handles list flattening at YAML parsing level via `construct_sequence()` override. This is cleaner (handles flattening during parse, not after) and more comprehensive (handles all sequences, not just buttons/dials).
- **Recommendation**: Close PR #206 with note about #279

### #278 - Fix nested includes âœ… MERGED
- **Files**: `home_assistant_streamdeck_yaml.py`, `tests/test_yaml.py`
- **Purpose**: Fix nested YAML include path resolution
- **How it works**: Uses file objects instead of strings so `stream.name` is available for `IncludeLoader._root`
- **Cleanup**: Added `_load_yaml_include` helper function, made `vars` optional in includes
- **Status**: Merged 2025-12-23

### #258 - Handle network disconnection gracefully âœ… MERGED
- **Files**: `home_assistant_streamdeck_yaml.py`, `tests/test_app.py`
- **Purpose**: Add retry logic for WebSocket connection failures
- **Features**: `--connection-retry-attempts` (-1 for infinite), `--connection-retry-delay`
- **Changes made during review**:
  - Changed `math.inf` to `-1` for infinite retries (cleaner API, avoids float/int type issues)
  - Removed redundant `ConnectionRefusedError` (subclass of OSError)
  - Earlier refactor by basnijholt widened exception catching (ConnectionClosed vs ConnectionClosedError)
- **Status**: Merged 2025-12-23

### #279 - Allow multiple includes âœ… MERGED
- **Files**: `home_assistant_streamdeck_yaml.py`, `tests/test_yaml.py`
- **Purpose**: Support multiple !include directives in lists, flattening the results
- **Implementation**: Overrides `construct_sequence` to detect `!include` in lists and flatten
- **Changes**: +79/-23 after merge with main, moved `_traverse_yaml` to module level
- **Status**: Merged 2025-12-23

### #251 - Add long press functionality âœ… MERGED
- **Files**: `home_assistant_streamdeck_yaml.py`, tests, config
- **Purpose**: Add long-press button support with configurable duration threshold
- **Dependencies**: Uses #259 refactor (now merged)
- **Features**:
  - `long_press_duration` config option (default 1.0s)
  - `long_press` button attribute for per-button override actions
  - Triggers on key RELEASE based on duration
- **Bugs fixed during review**:
  - `target` was missing from `allowed_keys` in `_validate_long_press`
  - Added type validation for `long_press.target` (must be a dict)
  - Templates in `long_press.service_data` weren't being rendered (values extracted before `rendered_template_button()`)
  - Fixed same issue for `long_press.service` templates
  - Updated `websockets.WebSocketClientProtocol` â†’ `websockets.ClientConnection` (deprecation fix)
- **Tests added**: 4 regression tests for the above fixes
- **Status**: Merged 2025-12-23
- **Follow-up**: #301 - Fix remaining websocket deprecation warning in test fixture

### #250 - Light page tweaks new ğŸ”„ Needs rebase
- **Files**: `home_assistant_streamdeck_yaml.py`, `tests/test_app.py`, `README.md`, config files
- **Purpose**: Enhance light-control page with configurable brightness levels and improved layout
- **Status**: CONFLICTING - needs rebase on main
- **Problem**: Branch was based on pre-#251 code and contains duplicate long_press implementation
  - The long_press functionality was already merged via PR #251
  - CI failing (docker, update_readme) due to merge conflicts
  - `mergeStateStatus: DIRTY`, `mergeable: CONFLICTING`
- **Actual new features** (once rebased):
  - `brightnesses` parameter in `special_type_data` for configurable brightness levels
  - `deck_key_count` parameter to `_light_page()` for proper layout calculation
  - Empty buttons fill page to ensure close-page button stays in consistent position
  - 0% brightness displays as "OFF" instead of "0%"
  - Default to 4 brightness values (0, 33, 66, 100) instead of 5
- **Required**: Author needs to rebase on main, removing duplicated long_press code
- **Recommendation**: Leave comment on PR asking @ngolf to rebase

### #277 - Fix lcd multi dial update bug
- **Files**: Main file + tests
- **Purpose**: Major dial update refactor
- **Dependencies**: May conflict with #276 changes
- **Notes**: Large PR, needs careful review

---

## Review Legend

| Symbol | Meaning |
|--------|---------|
| ğŸ”² | Not reviewed |
| ğŸ” | Under review |
| âœ… | Approved / Merged |
| âš ï¸ | Needs changes |
| âŒ | Rejected |
| ğŸ”„ | Needs rebase |

---

## Suggested Review Order

1. ~~**#257** - OBSOLETE (already in main via PR #246)~~
2. ~~**#278** - Fix nested includes~~ âœ… Merged
3. ~~**#279** - Allow multiple includes~~ âœ… Merged
4. ~~**#258** - Network disconnection~~ âœ… Merged
5. ~~**#251** - Long press~~ âœ… Merged
6. ~~**#172** - Signal handling (+22/-1)~~ ğŸ”„ Needs rebase - conflicts with retry logic
7. ~~**#206** - Flatten list (+27/-0)~~ âŒ CLOSED (superseded by #279)
8. ~~**#250** - Light page tweaks~~ ğŸ”„ Needs rebase - conflicts with #251 merge
9. **#173** - Sync state entity back to HA â† Next to review
